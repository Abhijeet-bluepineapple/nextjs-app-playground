name: Assertions and Static Report

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  lighthouse-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Cache Node Modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Dependencies
        run: npm install -g @unlighthouse/cli puppeteer netlify-cli

      - name: Run Unlighthouse CI
        id: unlighthouse
        run: unlighthouse-ci --build-static --json --output-path=.unlighthouse/ci-result.json

      - name: Deploy to Netlify
        run: netlify deploy --dir=.unlighthouse --prod --message="New Release Deploy from GitHub Actions"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Upload Unlighthouse Output
        uses: actions/upload-artifact@v3
        with:
          name: unlighthouse-output
          path: .unlighthouse/ci-result.json

      - name: Download Unlighthouse Output
        uses: actions/download-artifact@v3
        with:
          name: unlighthouse-output
          path: .

      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const output = JSON.parse(fs.readFileSync('./.unlighthouse/ci-result.json', 'utf8'));
            let commentBody = '## Unlighthouse Scores\n';
            output.forEach(page => {
              commentBody += `
              - **Path**: ${page.path}
                - **Performance**: ${page.score}
                - **Accessibility**: ${page.accessibility}
                - **Best Practices**: ${page["best-practices"]}
                - **SEO**: ${page.seo}
              `;
            });
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });